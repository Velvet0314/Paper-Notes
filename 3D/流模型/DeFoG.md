1. 基础知识
	- 离散流匹配（Discrete Flow Matching, DFM）
		$$p_{t|1}(z_t|z_1) = t \delta(z_t, z_1) + (1-t) p_0(z_t) \tag{1}$$

		* 目标：定义一个从**确定性数据点 $z_1$** 平滑地、线性地过渡到**先验噪声分布 $p_0$** 的概率路径。这个路径是所有后续推导的基石
		* **变量定义**：
		    * $z_1$：一 个离散的数据点（例如，一个节点的类别，$\text{one-hot}$ 编码）
		    * $z_t$：在时间 $t$ 的状态变量
		    * $p_{t|1}(z_t|z_1)$：给定初始数据点 $z_1$，在时间 $t$ 状态为 $z_t$ 的条件概率
		    * $t$：时间变量。$t=1$ 对应干净数据，$t=0$ 对应纯噪声
		    * $\delta(z_t, z_1)$：克罗内克（Kronecker）delta函数。当 $z_t = z_1$ 时为 1，否则为 0。在向量形式下，这代表一个在 $z_1$ 位置为 1 的 $\text{one-hot}$ 向量
		    * $p_0(z_t)$：一个预定义的先验噪声分布，通常是均匀分布 $p_0 = [1/Z, ..., 1/Z]$，其中 $Z$ 是状态总数
		* **解释:** 这个公式描述了一个非常直观的“混合”过程。
		    * 当 $t=1$ 时， $p_{1|1}(z_t|z_1) = \delta(z_t, z_1)$，概率质量完全集中在原始数据 $z_1$ 上，没有噪声
		    * 当 $t=0$ 时， $p_{0|1}(z_t|z_1) = p_0(z_t)$，数据完全被噪声替代，其分布为 $p_0$
		    * 当 $t \in (0, 1)$ 时，状态 $z_t$ 的概率是 $z_1$ 的 $\text{one-hot}$ 表示和噪声分布 $p_0$ 的**线性加权平均**。$t$ 越大，数据点“看起来”越像原始的 $z_1$
	- 连续马尔可夫链（CTMC）
		$$p_{t+dt|t}(z_{t+dt}|z_t) = \delta(z_t, z_{t+dt}) + R_t(z_t, z_{t+dt})dt \tag{2}$$
		* 目标：定义在一个**无穷小的时间步长 $dt$** 内，从当前状态 $z_t$ 转移到下一个状态 $z_{t+dt}$ 的概率。这是连续时间马尔可夫链 (CTMC) 动力学的基本方程，也是采样算法的理论基石
	    * **变量定义**：
	        * $p_{t+dt|t}(z_{t+dt}|z_t)$：从时间 $t$ 的状态 $z_t$ 到时间 $t+dt$ 的状态 $z_{t+dt}$ 的转移概率
	        * $\delta(z_t, z_{t+dt})$：克罗内克 delta 函数
	        * $R_t(z_t, z_{t+dt})$：速率矩阵 $R_t$ 中的一个元素，表示从状态 $z_t$ 到 $z_{t+dt}$ 的**瞬时转移速率**
	        * $dt$：一个无穷小的时间增量
	    * **解释**：这个公式可以分两种情况来理解，它完美地描述了在一个极短的时间内会发生什么：
	        1.  **情况一：状态发生改变 ($z_t \neq z_{t+dt}$)**
	            此时 $\delta(z_t, z_{t+dt}) = 0$，公式变为 $p_{t+dt|t}(z_{t+dt}|z_t) = R_t(z_t, z_{t+dt})dt$
	            - 在一个微小的时间窗口 $dt$ 内，系统从状态 A 跳到另一个不同状态 B 的概率，正比于从 A 到 B 的转移速率 $R_t(A, B)$ 和这个时间窗口的长度 $dt$。速率越高，时间越长，跳过去的概率就越大
	        2.  **情况二：状态保持不变 ($z_t = z_{t+dt}$)**
	            此时 $\delta(z_t, z_{t+dt}) = 1$，公式变为 $p_{t+dt|t}(z_t|z_t) = 1 + R_t(z_t, z_t)dt$
	            - 速率矩阵的对角线元素 $R_t(z_t, z_t)$ 按定义是负数，它等于所有离开该状态的速率之和的负值，即 $R_t(z_t, z_t) = -\sum_{z' \neq z_t} R_t(z_t, z')$。所以，这个表达式实际上是 $1 - (\sum_{z' \neq z_t} R_t(z_t, z')dt)$
	            - 在微小时间窗口 $dt$ 内，系统**留在**状态 A 的概率，等于1减去所有从 A **跳出去**的概率之和
	    * **推导过程**：这个公式是 **Kolmogorov 向前方程** ($\partial_t p_t = R_t^T p_t$) 的一阶**欧拉离散化 (Euler discretization)** 的结果。Kolmogorov 方程描述了概率分布 $p_t$ 随时间的连续演化。当我们要用计算机模拟这个过程时，我们无法处理连续的 $t$，必须把它切分成离散的步长 $\Delta t$
	- 去噪速率矩阵
		$$R_t^*(z_t, z_{t+dt}|z_1) = \frac{\text{ReLU}[\partial_t p_{t|1}(z_{t+dt}|z_1) - \partial_t p_{t|1}(z_t|z_1)]}{Z_t^{ \gt 0} p_{t|1}(z_t|z_1)} \tag{3}$$
		* **目标**：基于已知的加噪路径 $p_{t|1}$，构建一个连续时间马尔可夫链（CTMC）的**速率矩阵 $R_t^*$**，该矩阵能够驱动一个去噪过程，使得在任何时刻 $t$ 的状态分布都恰好是 $p_{t|1}$。这是Flow Matching思想的精髓——**用已知的流（加噪流）来匹配和定义一个未知的流（去噪流）**
		* **变量定义**：
		    * $R_t^*(z_t, z_{t+dt}|z_1)$：给定干净数据 $z_1$ 的条件下，在时间 $t$ 从状态 $z_t$ **瞬间转移**到状态 $z_{t+dt}$ 的速率。**注意，这只在 $z_t \neq z_{t+dt}$ 时定义**
		    * $\partial_t p_{t|1}(z_t|z_1)$：条件概率 $p_{t|1}$ 对时间 $t$ 的偏导数。它描述了在状态 $z_t$ 的概率质量随时间变化的“速度”
		    * $\text{ReLU}(x) = \max(0, x)$：修正线性单元。确保转移速率非负
		    * $Z_t^{\gt 0}$：在时刻 $t$ 概率不为零的状态数量
		* **解释**：这个公式的分子是核心。$\partial_t p_{t|1}$ 代表了概率流动的方向和速率
		    * 从公式(1)求导可得 $\partial_t p_{t|1}(z_t|z_1) = \delta(z_t, z_1) - p_0(z_t)$。这是一个常数，不随 $t$ 变化
		    * 分析分子 $\text{ReLU}[\partial_t p_{t|1}(z_{t+dt}|z_1) - \partial_t p_{t|1}(z_t|z_1)]$：
		        * **什么情况下会发生状态转移？** 只有当目标状态 $z_{t+dt}$ 的概率“增长速度”比当前状态 $z_t$ 的“增长速度”更快时，转移速率才大于零
		- 问题：ReLU 保证元素是非负的，为什么说速率矩阵的对角线元素 $R_t(z_t, z_t)$ 按定义是负数，它等于所有离开该状态的速率之和的负值？
			- 通过公式(3)计算出了所有**非对角线**的元素 $R_t(z_t, z_{t+dt})$ (for $z_{t+dt} \neq z_t$)，我们就可以根据“行和为零”的约束来确定对角线元素：$$R_t(z_t, z_t) + \sum_{z_{t+dt} \neq z_t} R_t(z_t, z_{t+dt}) = 0$$移项可得：$$R_t(z_t, z_t) = - \sum_{z_{t+dt} \neq z_t} R_t(z_t, z_{t+dt})$$
2. DeFoG Framework（图上的离散流匹配）
	1. 学习图上的离散流
		- 定义一个图 $G$ 为节点和边的集合 $G = (x^{1:n:N}, e^{1:i<j:N})$，$x^{1:n:N} = (x^{(n)})_{1 \leq n \leq N}, e^{1:i<j:N} = (e^{(ij)})_{1 \leq i \lt j \leq N}$，其中 $x^{(n)} \in \mathcal{X}$ 是节点 $n$ 的离散特征， $e^{(ij)} \in \mathcal{E}$ 是节点 $i$ 和 $j$ 之间边的离散特征
		- 加噪过程（Noising）
			- 将公式(1)的线性插值思想**独立地**应用到图的每一个节点和每一条边上
				$$p_{t|1}(G_t|G_1) = \prod_n p_{t|1}^{(n)}(x_t^{(n)}|x_1^{(n)}) \prod_{i<j} p_{t|1}^{(ij)}(e_t^{(ij)}|e_1^{(ij)})$$

			* **解释**：公式表明，一个完整的噪声图 $G_t$ 的生成，可以看作是所有节点和边**并行且独立地**进行各自的加噪过程。每个 $p_{t|1}^{(n)}$ 和 $p_{t|1}^{(ij)}$ 都遵循之前公式(1)定义的线性插值形式。这种分解处理极大地简化了问题，但它也带来了一个核心假设。
			* **关键假设**：
				1. 节点和边的加噪过程是**条件独立**的。虽然这在真实图结构中通常不成立，但在生成模型中，这是一个常见且有效的简化，模型的神经网络部分后续会负责学习和重建这些依赖关系。
				2. 点和边共享的初始分布，分别记为 $p_{0}^\mathcal{X}$ 和 $p_{0}^\mathcal{E}$，在正文中为简单起见假设暂时是相同的
		- 采样过程（Sampling）
			- 从一个完全随机的图 $G_0$ 开始（从预定义的初始分布 $p_0(G_0) = \prod_{n} p_0^{\mathcal{X}}(x_n^{(0)}) \prod_{i<j} p_{0}^{\mathcal{E}}(e_{ij}^{(0)})$ 中采样一个纯噪声图 $G_0$），通过一系列离散的时间步，逐步去噪，最终在 $t=1$ 时得到一个干净的图 $G_1$。每一步的“移动”都由一个速率矩阵 $R_t$ 驱动，速率矩阵由神经网络预测
				$$p_{t+\Delta t|t}(G_{t+\Delta t}|G_t) = \prod_n \tilde{p}_{t+\Delta t|t}^{(n)}(x_{t+\Delta t}^{(n)}|G_t) \prod_{i<j} \tilde{p}_{t+\Delta t|t}^{(ij)}(e_{t+\Delta t}^{(ij)}|G_t) \tag{4}$$
			* **变量定义**：
			    *   $p_{t+\Delta t|t}(G_{t+\Delta t}|G_t)$：从 $t$ 时刻的图 $G_t$ 转移到 $t+\Delta t$ 时刻的图 $G_{t+\Delta t}$ 的概率
			    *   $\Delta t$：一个有限大小的时间步长
			* **注**：
				1. 每个节点和边采用**独立**的欧拉步长
				2. 在时刻 $t$，为了得到 $G_{t+\Delta t}$，我们**独立地为每个节点和每条边**计算它们的转移概率，然后从这些概率中采样出它们的新状态。整个图的更新是并行完成的
			 $$R_t^{(n)}(x_t^{(n)}, x_{t+dt}^{(n)}) = \mathbb{E}_{p_{1|t}^{(n)}(x_1^{(n)}|G_t)}[R_t^{*(n)}(x_t^{(n)}, x_{t+dt}^{(n)}|x_1^{(n)})] \tag{5}$$
			* **变量定义**：
				* $R_t^{(n)}$：在时刻 $t$ 用于节点 $n$ 采样的**无条件**速率矩阵
				* $p_{1|t}^{(n)}(x_1^{(n)}|G_t)$：神经网络 $f_\theta$ 输入噪声图 $G_t$ 后，对节点 $n$ 的**干净状态** $x_1^{(n)}$ 做出的**预测概率分布**
				* $R_t^{*(n)}(...|x_1^{(n)})$：由公式(3)定义的、**以真实的干净状态 $x_1^{(n)}$ 为条件**的理想速率矩阵
			* **直观解释**：这是整个框架中最精妙的连接点。公式(3)告诉我们，只要知道了最终目标 $x_1$，就能算出完美的速率矩阵 $R_t^*$。但在采样时，我们并不知道 $x_1$。我们所拥有的，是神经网络对 $x_1$ 可能是什么样子的一个**概率性猜测** $p_{1|t}^{(n)}$。公式(5)做的就是，将理想的速率矩阵 $R_t^*$ 在这个神经网络给出的“信念分布” $p_{1|t}^{(n)}$ 上进行**期望（加权平均）**。换句话说，我们基于模型的所有可能预测，计算出一个平均的、最合理的演化方向。
			* **与模型的联系**：这清晰地展示了**训练与采样的解耦**。
				* **训练时 (Algorithm 1)**：神经网络 $f_\theta$ 的唯一任务就是学习输出一个准确的概率分布 $p_{1|t}^{(n)}(\cdot|G_t)$。
				* **采样时 (Algorithm 2)**：我们将 $f_\theta$ 的输出 $p_{1|t}^{(n)}$ **代入**公式(5)，计算出速率矩阵 $R_t^{(n)}$，再利用这个速率矩阵和公式(4)来执行一步采样。
		- 训练过程（Training）
	2. DeFoG 的设计空间
	3. 排列不变性保证