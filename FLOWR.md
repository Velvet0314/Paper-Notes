1. 流匹配的基本知识
	- **连续数据的流匹配（Flow Matching）**
		- 流匹配是一种生成模型框架，其目标是通过学习一个向量场 $v_t^\theta(x_t)$，将样本从初始分布 $p_0$ 迁移到目标分布 $p_1$。这个向量场会诱导一个随时间变化的密度 $p_t$，其两端点分别是 $p_0$ 和 $p_1$
		- 流匹配的关键思想在于可以通过以下步骤来学习该向量场：首先从目标分布采样 $x_1 \sim p_1(x_1)$，然后从条件概率路径 $x_t \sim p_{t|1}(x_t|x_1)$ 中采样，该路径对应一个向量场 $u_t(x_t|x_1)$，最后将 $v_t^\theta(x_t)$ 回归拟合到 $u_t(x_t|x_1)$ 上
			- $p_{t|1}$​ 里的下标表示：时间为 $t$，且条件在终点分布 $x_1$ 上
			- $x_t \sim p_{t|1}(x_t|x_1)$ 表示给定一个从目标分布采到的样本 $x_1$​，我们再在路径中间的时间 $t$ 采样 $x_t$​
	- **离散流模型（Discrete Flow Models）**
		- 有研究提出基于 **连续时间马尔可夫链（CTMC）** 的序列生成框架，将流匹配方法扩展到 **离散类别数据**。这些方法与连续流匹配类似：首先定义条件概率路径 $p_{t|1}(\cdot|x_1)$，然后学习一个数据去噪器 $p_\theta^{t|1}(\cdot|x_t)$，在推理过程中利用它将 $x_t$​ 推向真实数据分布
2. 模型架构
	- 基于**SemlaFlow** 模型 —— SemlaFlow 在 **无条件三维分子生成任务** 上取得了当前最优的结果，其核心的 **Semla 架构** 是一种 **E(3)-等变架构**，通过多项创新显著提升了效率与可扩展性
	- 对 Semla 架构进行了扩展，使其能够支持**条件生成**
		- **口袋编码器（pocket encoder）** —— 其不依赖于时间步 $t$ 或配体 $l_t$​，因此在生成配体时仅需一次前向传播即可完成编码，进一步保证了方法的高效性
		- **配体解码器（ligand decoder）** —— 其中加入了**交叉注意力模块**。该模块的设计与 Semla 中提出的注意力模块类似，使用 **两层 MLP** 生成注意力分数。它会同时接收**口袋 $\mathcal{P}$ 的不变与等变嵌入** 以及 **配体 $l_t$​** 的嵌入，并可选地引入 **相互作用信息 $\mathcal{I}$**，从而实现基于蛋白质口袋及期望相互作用的结构条件约束（使用**潜在注意力操作（latent attention operation）**，以显著提升该过程的效率）
	- 对 Semla 内部的一些现有组件进行了改进，从而进一步提升了模型的性能与效率
		- 基于**门控(gating)的等变前馈网络**替换了 Semla 中的等变前馈模块(equivariant feed-forward module)。具体来说，如果原子 $i$ 的不变与等变输入特征分别记为 $h_i \in \mathbb{R}^{d_{inv}}$ 和 $x_i \in \mathbb{R}^{3 \times d_{equi}}$，那么输出为：
			$$x_i^{out} = W_\theta^2 \tilde{x}_i \quad \text{其中} \quad \tilde{x}_i = \sigma(\Phi_\theta(h_i, ||x_i||)) \odot W_\theta^1 x_i$$

			这里 $\sigma$ 表示应用于不变特征的元素级 sigmoid 函数，$\odot$ 表示逐元素乘法，$W_\theta^1 \in \mathbb{R}^{d_{equi} \times d_{equi}}$ 和 $W_\theta^2 \in \mathbb{R}^{d_{equi} \times d_{equi}}$ 都是权重矩阵，$\Phi_\theta$ 是一个两层的MLP
			- 该模块的速度显著快于 Semla 使用的等变前馈模块
		- 在每一层的自注意力模块中都传递了**键的嵌入（bond embeddings）**，而不是像 Semla 那样仅在第一层传递。这一改动提升了生成分子的有效性，同时对推理时间的影响非常小
			- 在配体原子之间进行每一次信息交换时，都不断地提醒模型它们之间的**共价键结构**。这有助于模型更好地维持分子的化学合理性，为空间上的注意力机制增加了一层基于拓扑结构的强先验
3. 训练与推理
	- 模型训练
		- **目标**：生成以给定结构为条件的新配体
		- 由于3D分子图包含**连续和分类数据类型**的混合，FLOWR联合生成连续和离散分布，使用连续的流匹配和离散六模型。配体形式电荷不通过流学习，而是简单地通过模型预测
		- 训练通过采样配体噪声 $l_0 \sim p_{noise}$、配体、口袋和相互作用拓扑 $(l_1, \mathcal{P}, \mathcal{I})$ 在时间 $t \in [0,1]$ 进行。我们使用高斯噪声用于坐标和原子和键类型的均匀分布来创建 $p_{noise}$。然后从相同的条件概率路径 $l_t \sim p_{t|1}(l_t|l_1)$ 中采样一个噪声配体，该路径定义如下：
			$$t \sim \text{Beta}(\alpha, \beta) \quad x_t \sim \mathcal{N}(tx_1 + (1-t)x_0, \sigma^2) \quad (1)$$$$a_t \sim \text{Cat}(t\delta(a_1) + (1-t)\frac{1}{|A|}) \quad b_t \sim \text{Cat}(t\delta(b_1) + (1-t)\frac{1}{|B|}) \quad (2)$$
			- 其中 $A$ 和 $B$ 分别是**原子类型和键序的可能值集合**，$\delta(.)$是应用于序列中每个项目的独热编码操作。论文中对所有 FLOWR 模型使用值 $\alpha = 2.0, \beta = 1.0$ 和 $\sigma = 0.2$ 
			- Beta 分布
				$$f(x;\alpha,\beta)=\frac{x^{\alpha-1}(1-x)^{\beta-1}}{B(\alpha,\beta)}$$
				- 其中 $B(\alpha, \beta) = \int_0^1 t^{\alpha-1}(1-t)^{\beta-1} dt$，那么在 $\alpha = 2.0, \beta = 1.0$ 时其概率密度函数为 $f(x)=2x$，所以概率密度随着 $x$ 的增大而线性增加，这表示从这个分布中随机抽取一个数，**抽到接近 1 的数的可能性，要远大于抽到接近 0 的数**
				- 意义：从纯噪声开始的早期阶段，向量场的方向相对简单（大致指向数据中心即可），可能不需要那么密集的训练，**对于生成高质量的分子而言，学习如何在最后阶段精确地去除少量噪声，比学习如何从一团乱麻中构建出大致轮廓更为关键和困难**
	- 模型推理
		- **目标**：生成一个配体，使其不仅在几何上与蛋白口袋相容，而且其一部分原子（我们称之为**固定原子**）必须精确地位于预先指定的位置，以满足特定的关键相互作用（如氢键、盐桥等）
		- **配体表示**：
			- 设 $\mathbf{X}_p = \{x_{p,j} \in \mathbb{R}^3 : j = 1,\ldots,n_p\}$ 表示 $n_p$ 个口袋原子的 3D 坐标，$\mathbf{X}^{(0)} = \{x_i^{(0)} \in \mathbb{R}^3 : i = 1,\ldots,n_l\}$ 表示 $n_l$ 个配体原子的真实（原生）3D 坐标
		- **变量定义**：
			- 设 $I \in \{0,1\}^{n_p \times n_l \times d_I}$ 为相互作用张量，其中条目 $I_{j,i,k}$ 表示口袋原子 $j$ 和配体原子 $i$ 是否参与类型 $k$ 的相互作用（具有 $d_I$ 个可能的相互作用通道）
		- **掩码定义**：
			- 二进制掩码 $M \in \{0,1\}^{n_l}$
				$$M_i = \mathbb{I}\{\sum_{j=1}^{n_p}\sum_{k=1}^{d_I} I_{j,i,k} > 0\}, \quad i = 1,\ldots,n_l$$
				此掩码将配体原子划分为：**固定原子** $\mathcal{I} = \{i : M_i = 1\}$ 和**待生成的自由原子** $\mathcal{F} = \{i : M_i = 0\}$
		- **两种原子的路径定义**：
			- 对于原子坐标（同样适用于分类空间中的原子类型），我们定义在时间 $t \in [0,1]$ 上的连续插值，介于先验分布（$t = 0$ 时的各向同性高斯噪声）和数据分布（$t = 1$ 时）之间
			- 对于自由原子（$i \in \mathcal{F}$）：设 $\mathbf{z}_i$ 为从先验中的样本：$$\mathbf{z}_i \sim \mathcal{N}(0, \sigma^2 \mathbf{I}_3)$$
				插值为： $$\mathbf{x}_{l,i}(t) = (1-t)\mathbf{z}_i + t\mathbf{x}_{l,i}^{(0)}$$
				- 解释：自由原子的坐标 $x_{l,i}(t)$ 从一个随机高斯噪声 $z_i$ (在 $t=0$ 时) 平滑地线性插值到它们在真实分子中的最终位置 $x_{l,i}^{(0)}$ (在 $t=1$ 时)。它们是在**运动和变化**的
			- 对于固定原子（$i \in \mathcal{I}$）：由于这些原子被条件为==**保持不变**==，我们简单地设置 $$\mathbf{x}_{l,i}(t) = \mathbf{x}_{l,i}^{(0)} \quad \text{对于所有} t \in [0,1]$$
				因此， $$\dot{\mathbf{x}}_{l,i}(t) = 0$$
				- 解释：这些“锚点”原子的坐标在整个时间流中 ($t$ 从 0 到 1) **始终保持不变**，永远等于它们在最终真实分子中的位置 $x_{l,i}^{(0)}$。它们是**静止**的
				- $\mathbf{x}_{l,i}$ 表示配体 $l$ 的第 $i$ 个原子坐标
				- $\dot{f}$ 表示对时间 $t$ 的导数，$\dot{\mathbf{x}}_{l,i}(t)$ 表示配体中第 $i$ 个原子在时间 $t$ 的瞬时速度
		- 向量场推导：
			- 训练一个 FLOWR 模型 $F_\theta$，将配体坐标（在时间 $t$）、口袋坐标和时间 $t$ 映射到每个配体原子的 $\mathbb{R}^3$ 中的向量：$$F_\theta : (\mathbf{X}_l(t), \mathbf{X}_p, t) \mapsto \mathbb{R}^{n_l \times 3}$$
			- 对于自由原子（$i \in \mathcal{F}$）： $$F_\theta\left(\mathbf{x}_{l,i}(t), \mathbf{X}_p, t\right) \approx \dot{\mathbf{x}}_{l,i}(t) = \mathbf{x}_{l,i}^{(0)}$$
			- 对于固定原子（$i \in \mathcal{I}$）： $$F_\theta\left(\mathbf{x}_{l,i}(t), \mathbf{X}_p, t\right) \approx 0$$

			- 在测试时，给定口袋 $\mathbf{X}_p$ 和已知的原生配体几何 $\mathbf{X}_l^{(0)}$（其固定原子由 $M$ 指示），我们通过求解以下 ODE生成自由原子：$$\frac{d}{dt}\mathbf{x}_{l,i}(t) = F_\theta\left(\mathbf{x}_{l,i}(t), \mathbf{X}_p, t\right)$$
				初始条件为 $$\mathbf{x}_{l,i}(0) = \begin{cases} \mathbf{z}_i, & i \in \mathcal{F}, \\ \mathbf{x}_{l,i}^{(0)}, & i \in \mathcal{I}, \end{cases} \quad \text{且} \quad \mathbf{z}_i \sim p_{\text{prior}}$$